<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Exam Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* --- DESIGN SYSTEM: PASTEL ADVANCE --- */
        :root {
            --primary: #42b883;
            --primary-dark: #33a06f;
            --primary-light: #d1fae5;
            --bg-body: #f0fdf4; /* Lebih soft */
            --white: #ffffff;
            --text-main: #334155;
            --text-muted: #94a3b8;
            --danger: #fb7185;
            --warning: #fbbf24;
            --shadow-card: 0 4px 20px -2px rgba(66, 184, 131, 0.1);
            --radius: 16px;
        }

        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            min-height: 100vh;
        }

        .container { max-width: 900px; margin: 0 auto; padding-bottom: 80px; }

        /* --- HEADER & STATS --- */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--primary-dark); font-size: 1.8rem; margin: 0; letter-spacing: -0.5px; }
        p.subtitle { color: var(--text-muted); font-size: 0.9rem; margin-top: 5px; }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;
        }
        .stat-card {
            background: var(--white); padding: 15px; border-radius: var(--radius);
            box-shadow: var(--shadow-card); text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--primary); display: block; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- SEARCH BAR --- */
        .search-container {
            position: relative; margin-bottom: 20px;
        }
        .search-icon {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            color: var(--text-muted); font-size: 1.2rem;
        }
        .search-input {
            width: 100%; padding: 15px 15px 15px 45px;
            border: none; border-radius: var(--radius);
            background: var(--white); box-shadow: var(--shadow-card);
            font-size: 1rem; color: var(--text-main); outline: none; transition: 0.3s;
        }
        .search-input:focus { box-shadow: 0 0 0 3px var(--primary-light); }

        /* --- CARD & TABLE SYSTEM --- */
        .card {
            background: var(--white); border-radius: var(--radius);
            box-shadow: var(--shadow-card); padding: 25px; margin-bottom: 20px;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Table Styling */
        .table-container { width: 100%; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        
        thead th { 
            text-align: left; padding: 15px; color: var(--text-muted); 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 2px solid var(--bg-body);
        }
        tbody td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tbody tr:last-child td { border-bottom: none; }

        .badge-bab {
            background: var(--primary-light); color: var(--primary-dark);
            padding: 5px 10px; border-radius: 8px; font-weight: 600; font-size: 0.85rem;
        }

        /* Action Buttons */
        .btn-group { display: flex; gap: 8px; }
        button {
            padding: 8px 16px; border-radius: 10px; border: none; cursor: pointer;
            font-weight: 600; font-size: 0.85rem; transition: 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 5px;
        }
        button:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(66, 184, 131, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-remed { background: #fffbeb; color: #d97706; border: 1px solid #fcd34d; }
        .btn-remed:disabled { background: #f1f5f9; color: #cbd5e1; border-color: transparent; }
        .btn-outline { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); }

        /* --- MOBILE RESPONSIVE (CARD VIEW) --- */
        @media screen and (max-width: 768px) {
            /* Sembunyikan Header Tabel Desktop */
            thead { display: none; }
            
            /* Ubah Baris jadi Kartu */
            tbody tr {
                display: block; margin-bottom: 15px;
                background: #fff; border: 1px solid #f1f5f9;
                border-radius: 12px; padding: 15px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            }
            tbody td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 8px 0; border-bottom: 1px dashed #f1f5f9;
                text-align: right;
            }
            tbody td:last-child { border-bottom: none; padding-top: 15px; justify-content: flex-end; }
            
            /* Label Pseudo-Element (Data Label) */
            tbody td::before {
                content: attr(data-label);
                font-size: 0.8rem; font-weight: 600; color: var(--text-muted);
                text-transform: uppercase; margin-right: 15px;
            }
            
            /* Stats Grid jadi 1 baris scrollable atau stack */
            .stats-grid { gap: 10px; }
            .stat-val { font-size: 1.2rem; }
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .loading { text-align: center; padding: 40px; color: var(--primary); }
        .empty-state { text-align: center; padding: 30px; color: var(--text-muted); }
        
        /* Quiz UI Elements (Keep from previous) */
        #view-quiz .card { padding: 20px; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #timer { background: #fee2e2; color: #ef4444; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        .soal-text { font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px; }
        
        .opsi-item {
            padding: 14px; margin-bottom: 10px; border: 2px solid #f1f5f9; border-radius: 12px;
            cursor: pointer; display: flex; gap: 12px; align-items: center; transition: 0.2s;
        }
        .opsi-item.active { border-color: var(--primary); background: var(--primary-light); }
        .opsi-item.benar { background: #dcfce7 !important; border-color: var(--primary) !important; }
        .opsi-item.salah { background: #fee2e2 !important; border-color: var(--danger) !important; }
        
        /* Toggle */
        .switch { position: relative; display: inline-block; width: 42px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Exam Dashboard</h1>
        <p class="subtitle">Platform Latihan Ujian & Remedial</p>
    </header>

    <div id="view-dashboard">
        
        <div class="stats-grid hidden" id="stats-panel">
            <div class="stat-card">
                <span class="stat-val" id="stat-total">0</span>
                <span class="stat-label">Total Bab</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-avg">0</span>
                <span class="stat-label">Avg Skor</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-done">0</span>
                <span class="stat-label">Selesai</span>
            </div>
        </div>

        <div class="search-container hidden" id="search-panel">
            <i class="ph ph-magnifying-glass search-icon"></i>
            <input type="text" id="search-input" class="search-input" placeholder="Cari Bab atau Topik..." onkeyup="filterDashboard()">
        </div>

        <div class="card">
            <div id="loading" class="loading">
                <i class="ph ph-spinner ph-spin" style="font-size: 2rem;"></i><br>
                Sedang memuat data...
            </div>
            
            <div id="dashboard-content" class="table-container hidden">
                <table id="main-table">
                    <thead>
                        <tr>
                            <th width="15%">ID Bab</th>
                            <th width="35%">Topik</th>
                            <th width="15%">Skor</th>
                            <th width="20%">Terakhir</th>
                            <th width="15%">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
                <div id="empty-msg" class="empty-state hidden">
                    <i class="ph ph-smiley-sad" style="font-size: 2rem;"></i>
                    <p>Tidak ditemukan bab dengan kata kunci tersebut.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="view-quiz" class="hidden">
        <div class="card">
            <div class="quiz-header">
                <div>
                    <h3 id="quiz-title" style="margin:0; font-size:1.1rem; color:var(--primary-dark)">Bab Title</h3>
                    <span id="quiz-subtitle" style="font-size:0.8rem; color:var(--text-muted)">Mode Ujian</span>
                </div>
                <div id="timer">00:00</div>
            </div>

            <div style="height:6px; background:#f1f5f9; border-radius:10px; margin-bottom:20px; overflow:hidden;">
                <div id="progress-bar" style="height:100%; background:var(--primary); width:0%; transition:0.3s;"></div>
            </div>

            <div id="review-panel" class="hidden" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:#fff1f2; padding:10px; border-radius:10px;">
                <span style="font-size:0.8rem; font-weight:600; color:#9f1239;">Tandai Remedial</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-remedial" onchange="toggleRemedial(this)">
                    <span class="slider round"></span>
                </label>
            </div>

            <div id="soal-container">
                <div id="soal-text" class="soal-text"></div>
                <div id="opsi-list"></div>
            </div>

            <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn-outline" onclick="nav(-1)" id="btn-prev"><i class="ph ph-caret-left"></i> Prev</button>
                <button class="btn-outline" onclick="nav(1)" id="btn-next">Next <i class="ph ph-caret-right"></i></button>
            </div>
            
            <button class="btn-primary" style="width:100%; margin-top: 20px; padding: 12px;" onclick="finishExam()" id="btn-finish">Selesai & Simpan</button>
            <button class="btn-outline" style="width:100%; margin-top: 20px; display:none;" onclick="location.reload()" id="btn-home">Kembali ke Dashboard</button>
        </div>
    </div>

    <div id="view-result" class="card hidden" style="text-align: center; padding: 40px 20px;">
        <div style="width:100px; height:100px; background:var(--primary-light); color:var(--primary-dark); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2.5rem; font-weight:700; margin:0 auto 20px;">
            <span id="result-score">0</span>
        </div>
        <h2 style="margin:0; color:var(--text-main);">Ujian Selesai!</h2>
        <p id="result-msg" style="color:var(--text-muted); margin-bottom:30px;"></p>
        
        <div style="display: grid; gap: 10px;">
            <button class="btn-primary" onclick="location.reload()">Ke Menu Utama</button>
            <button class="btn-outline" onclick="enterReviewMode()">Review Jawaban</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const API_URL = "https://script.google.com/macros/s/AKfycbxGeMMPL_N0zPBYdF8SawZa66-0tkCTexXzmnLrjJrXMYBzTIooVNz25MTyLVwN3XB_nQ/exec"; 

// --- STATE ---
let allData = [];
let activeData = [];
let currentIndex = 0;
let userAnswers = {};
let isReviewMode = false;
let currentBabID = "";
let timerInterval;
let secondsElapsed = 0;

// --- INIT ---
document.addEventListener("DOMContentLoaded", () => {
    fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            allData = data;
            renderDashboard();
            calculateStats();
        })
        .catch(err => {
            document.getElementById("loading").innerHTML = "<span style='color:red'>Gagal koneksi server. Refresh halaman.</span>";
        });
});

// --- DASHBOARD FUNCTIONS ---
function renderDashboard() {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("dashboard-content").classList.remove("hidden");
    document.getElementById("search-panel").classList.remove("hidden");
    document.getElementById("stats-panel").classList.remove("hidden"); // Menampilkan Panel Stats
    document.getElementById("stats-panel").style.display = "grid"; // Fix display grid

    const tbody = document.getElementById("table-body");
    tbody.innerHTML = "";

    const groups = {};
    allData.forEach(item => {
        if (!groups[item.bab]) {
            groups[item.bab] = {
                id: item.bab,
                name: item.namaBab || "Tanpa Judul",
                lastScore: item.lastScore,
                lastTest: item.lastTest,
                remedialCount: 0
            };
        }
        if (item.note === "ULANG") groups[item.bab].remedialCount++;
    });

    Object.values(groups).forEach(g => {
        const tr = document.createElement("tr");
        tr.className = "dashboard-row"; // Class untuk target search
        
        let dateStr = "-";
        if(g.lastTest) {
            const d = new Date(g.lastTest);
            if(!isNaN(d)) dateStr = d.toLocaleDateString('id-ID', {day:'numeric', month:'short'});
        }

        let scoreDisplay = `<span style="color:#cbd5e1">-</span>`;
        if(g.lastScore !== "") {
            const color = g.lastScore >= 75 ? 'var(--primary)' : 'var(--danger)';
            scoreDisplay = `<span style="font-weight:700; color:${color}">${g.lastScore}</span>`;
        }

        // data-label attribute digunakan untuk Tampilan Mobile (Card View)
        tr.innerHTML = `
            <td data-label="Bab"><span class="badge-bab">${g.id}</span></td>
            <td data-label="Topik" class="topic-text" style="font-weight:500">${g.name}</td>
            <td data-label="Skor">${scoreDisplay}</td>
            <td data-label="Waktu">${dateStr}</td>
            <td data-label="Aksi">
                <div class="btn-group">
                    <button class="btn-primary" onclick="startQuiz('${g.id}', 'full')">Mulai</button>
                    <button class="btn-remed" ${g.remedialCount === 0 ? 'disabled' : ''} onclick="startQuiz('${g.id}', 'remed')">
                        <i class="ph ph-warning-circle"></i> ${g.remedialCount}
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- NEW FEATURES ---

// 1. SEARCH FUNCTION
function filterDashboard() {
    const input = document.getElementById("search-input").value.toLowerCase();
    const rows = document.querySelectorAll(".dashboard-row");
    let hasResult = false;

    rows.forEach(row => {
        const babText = row.querySelector(".badge-bab").innerText.toLowerCase();
        const topicText = row.querySelector(".topic-text").innerText.toLowerCase();

        if (babText.includes(input) || topicText.includes(input)) {
            row.style.display = ""; // Show default (table-row or block)
            hasResult = true;
        } else {
            row.style.display = "none";
        }
    });

    // Show empty state if no result
    const emptyMsg = document.getElementById("empty-msg");
    const tableEl = document.getElementById("main-table");
    
    if (hasResult) {
        emptyMsg.classList.add("hidden");
        tableEl.classList.remove("hidden");
    } else {
        emptyMsg.classList.remove("hidden");
        tableEl.classList.add("hidden");
    }
}

// 2. STATS CALCULATION
function calculateStats() {
    const groups = {};
    allData.forEach(item => {
        if (!groups[item.bab]) {
            groups[item.bab] = { score: item.lastScore };
        }
    });

    const totalBab = Object.keys(groups).length;
    let totalScore = 0;
    let finishedCount = 0;
    let babWithScore = 0;

    Object.values(groups).forEach(g => {
        if(g.score !== "") {
            totalScore += parseInt(g.score);
            babWithScore++;
            finishedCount++;
        }
    });

    const avgScore = babWithScore > 0 ? Math.round(totalScore / babWithScore) : 0;

    document.getElementById("stat-total").innerText = totalBab;
    document.getElementById("stat-avg").innerText = avgScore;
    document.getElementById("stat-done").innerText = finishedCount;
}

// --- QUIZ LOGIC (Standard) ---
function startQuiz(babID, mode) {
    currentBabID = babID;
    isReviewMode = false;
    userAnswers = {};
    secondsElapsed = 0;
    
    let questions = allData.filter(x => x.bab == babID);
    if(mode === 'remed') questions = questions.filter(x => x.note === "ULANG");
    
    questions.sort((a,b) => a.nomor - b.nomor);
    activeData = questions;
    currentIndex = 0;

    document.getElementById("view-dashboard").classList.add("hidden");
    document.getElementById("view-quiz").classList.remove("hidden");
    document.getElementById("view-result").classList.add("hidden");
    
    document.getElementById("quiz-title").innerText = `Bab ${babID}`;
    document.getElementById("quiz-subtitle").innerText = mode === 'full' ? 'Latihan Penuh' : 'Remedial';
    document.getElementById("btn-finish").style.display = "block";
    document.getElementById("btn-home").style.display = "none";
    document.getElementById("review-panel").style.display = "none"; // Hide first

    runTimer();
    renderQuestion();
}

function renderQuestion() {
    const q = activeData[currentIndex];
    
    // Progress
    const pct = ((currentIndex + 1) / activeData.length) * 100;
    document.getElementById("progress-bar").style.width = pct + "%";

    document.getElementById("soal-text").innerHTML = `<strong>${q.nomor}.</strong> ${q.soal}`;

    if(isReviewMode) {
        const panel = document.getElementById("review-panel");
        panel.style.display = "flex";
        panel.classList.remove("hidden");
        
        const toggle = document.getElementById("toggle-remedial");
        // Get fresh status
        const item = allData.find(x => x.bab == q.bab && x.nomor == q.nomor);
        toggle.checked = (item.note === "ULANG");
        toggle.dataset.bab = q.bab;
        toggle.dataset.nomor = q.nomor;
    }

    let html = "";
    Object.keys(q.opsi).forEach(k => {
        let cls = "opsi-item";
        if(userAnswers[q.nomor] === k) cls += " active";
        if(isReviewMode) {
            if(k === q.jawaban) cls += " benar";
            else if(userAnswers[q.nomor] === k) cls += " salah";
        }
        html += `<div class="${cls}" onclick="selectAnswer('${k}')">
                    <div style="width:24px; height:24px; background:#e2e8f0; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.8rem; font-weight:700;">${k}</div>
                    <div style="font-size:0.95rem;">${q.opsi[k]}</div>
                 </div>`;
    });
    document.getElementById("opsi-list").innerHTML = html;

    document.getElementById("btn-prev").disabled = (currentIndex === 0);
    document.getElementById("btn-next").disabled = (currentIndex === activeData.length - 1);
}

function selectAnswer(k) {
    if(isReviewMode) return;
    userAnswers[activeData[currentIndex].nomor] = k;
    renderQuestion();
}

function nav(step) {
    currentIndex += step;
    renderQuestion();
}

function runTimer() {
    clearInterval(timerInterval);
    const el = document.getElementById("timer");
    timerInterval = setInterval(() => {
        secondsElapsed++;
        const m = Math.floor(secondsElapsed / 60).toString().padStart(2,'0');
        const s = (secondsElapsed % 60).toString().padStart(2,'0');
        el.innerText = `${m}:${s}`;
    }, 1000);
}

function finishExam() {
    const answered = Object.keys(userAnswers).length;
    if(answered < activeData.length) {
        if(!confirm(`Masih ada soal kosong (${answered}/${activeData.length}). Selesaikan?`)) return;
    }
    clearInterval(timerInterval);

    let correct = 0;
    activeData.forEach(q => {
        if(userAnswers[q.nomor] === q.jawaban) correct++;
    });

    const score = Math.round((correct / activeData.length) * 100);
    
    document.getElementById("view-quiz").classList.add("hidden");
    document.getElementById("view-result").classList.remove("hidden");
    document.getElementById("result-score").innerText = score;
    document.getElementById("result-msg").innerText = `Kamu menjawab ${correct} benar dari ${activeData.length} soal.`;

    // Save
    const now = new Date();
    saveData(currentBabID, score, now.toISOString());
}

function saveData(bab, score, dateIso) {
    fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            action: "saveScore",
            bab: bab,
            score: score,
            tanggal: dateIso
        })
    }).then(() => console.log("Saved"));
}

function enterReviewMode() {
    isReviewMode = true;
    currentIndex = 0;
    document.getElementById("view-result").classList.add("hidden");
    document.getElementById("view-quiz").classList.remove("hidden");
    document.getElementById("btn-finish").style.display = "none";
    document.getElementById("btn-home").style.display = "block";
    renderQuestion();
}

function toggleRemedial(el) {
    const bab = el.dataset.bab;
    const nomor = el.dataset.nomor;
    const action = el.checked ? "tandai" : "hapus";

    // Update Local
    const item = allData.find(x => x.bab == bab && x.nomor == nomor);
    if(item) item.note = el.checked ? "ULANG" : "";

    fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: action, bab: bab, nomor: nomor })
    });
}
</script>

</body>
</html>
