<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ujian Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f1f5f9;
            --card-bg: #ffffff;
            --text: #1e293b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 900px; margin: 0 auto; }

        /* HEADER */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: var(--primary); margin: 0; font-size: 1.8rem; }
        p { color: #64748b; margin-top: 5px; }

        /* CARD STYLE */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            padding: 20px;
            overflow: hidden;
            animation: fadeIn 0.4s ease;
        }

        /* TABLE STYLE (DASHBOARD) */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 12px 16px; background: #f8fafc; color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); }
        td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        .bab-badge { 
            background: #e0e7ff; color: var(--primary); 
            padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.85rem; 
        }
        .score-badge { font-weight: 700; color: #0f172a; }
        
        /* ACTION BUTTONS IN TABLE */
        .btn-group { display: flex; gap: 8px; }
        .btn-action {
            padding: 8px 12px; border-radius: 6px; border: none; 
            font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .btn-start { background: var(--primary); color: white; }
        .btn-start:hover { background: var(--primary-dark); }
        
        .btn-remed { background: var(--warning); color: #fff; }
        .btn-remed:hover { background: #d97706; }
        .btn-remed:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }

        /* QUIZ ZONE UI (REUSED) */
        .progress-container { height: 6px; background: #e2e8f0; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        #progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        
        .opsi {
            border: 2px solid var(--border); padding: 15px; margin: 10px 0; border-radius: 10px;
            cursor: pointer; display: flex; align-items: center; transition: 0.2s;
        }
        .opsi:hover { border-color: var(--primary); background: #f5f3ff; }
        .opsi.active { border-color: var(--primary); background: #eef2ff; }
        .opsi.benar { background: #dcfce7 !important; border-color: var(--success) !important; }
        .opsi.salah { background: #fee2e2 !important; border-color: var(--danger) !important; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 25px; }
        button { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        
        /* TOGGLE SWITCH */
        .review-tools { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 24px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--danger); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* UTILS */
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Result Screen */
        .result-circle { width: 100px; height: 100px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; margin: 0 auto 20px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Sistem Ujian Pro</h1>
        <p>Pilih Bab untuk memulai latihan atau remedial.</p>
    </header>

    <div id="dashboard-view" class="card">
        <p style="text-align:center;" id="loading-text">Sedang memuat data...</p>
        <div class="table-responsive hidden" id="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="10%">Bab</th>
                        <th width="40%">Topik Bahasan</th>
                        <th width="15%">Score Terakhir</th>
                        <th width="35%">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="quiz-view" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="judul-quiz" style="margin:0; color:var(--primary);">Bab 1</h3>
            <div id="timer" style="font-weight:bold; color:var(--danger);">00:00</div>
        </div>
        
        <div class="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="review-header" class="review-tools hidden">
            <span style="font-size:0.9rem; font-weight:600; color:#64748b;">Perlu Remedial?</span>
            <label class="switch">
                <input type="checkbox" id="toggle-remedial" onchange="toggleMarking(this)">
                <span class="slider round"></span>
            </label>
        </div>

        <div id="soal-area">
            <div id="soal-text" style="font-size:1.1rem; line-height:1.6; margin-bottom:20px;"></div>
            <div id="opsi-list"></div>
        </div>

        <div class="nav-buttons">
            <button class="btn-outline" onclick="nav(-1)" id="btn-prev">⬅ Kembali</button>
            <button class="btn-outline" onclick="nav(1)" id="btn-next">Lanjut ➡</button>
        </div>
        <div style="margin-top: 20px;">
            <button class="btn-primary" style="width:100%" onclick="finishExam()" id="btn-finish">Selesai & Simpan Nilai</button>
            <button class="btn-outline" style="width:100%; margin-top:10px;" onclick="backToMenu()" id="btn-back-menu" class="hidden">Kembali ke Menu</button>
        </div>
    </div>

    <div id="result-overlay" class="card hidden" style="text-align:center;">
        <h2>Hasil Ujian</h2>
        <div class="result-circle" id="result-score">0</div>
        <p id="result-msg"></p>
        <button class="btn-primary" onclick="window.location.reload()">Ke Menu Utama</button>
        <button class="btn-outline" onclick="reviewMode()">Review Jawaban</button>
    </div>
</div>

<script>
// --- KONFIGURASI ---
const API_URL = "https://script.google.com/macros/s/AKfycbzY3FPb2StW0S2VY7l2x17kux9Nq18Cj1YHYbhdB1qhrJsm67zmaZex__wZlez4NUO1/exec";

// --- VARIABEL GLOBAL ---
let allData = [];
let activeQuestions = [];
let currentIndex = 0;
let userAnswers = {};
let isReviewMode = false;
let currentBab = "";
let timerInterval;
let seconds = 0;

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => {
    fetchData();
});

function fetchData() {
    fetch(API_URL)
        .then(r => r.json())
        .then(data => {
            allData = data;
            renderDashboard(data);
        })
        .catch(e => {
            document.getElementById("loading-text").innerText = "Gagal mengambil data.";
            console.error(e);
        });
}

// --- DASHBOARD LOGIC ---
function renderDashboard(data) {
    document.getElementById("loading-text").classList.add("hidden");
    const tableContainer = document.getElementById("table-container");
    const tbody = document.getElementById("table-body");
    tableContainer.classList.remove("hidden");
    tbody.innerHTML = "";

    // Grouping data by BAB
    const grouped = {};
    data.forEach(item => {
        if (!grouped[item.bab]) {
            grouped[item.bab] = {
                bab: item.bab,
                nama: item.namaBab || "Tanpa Nama",
                score: item.lastScore || "-",
                total: 0,
                remedialCount: 0
            };
        }
        grouped[item.bab].total++;
        if (item.note === "ULANG") grouped[item.bab].remedialCount++;
    });

    // Render Rows
    Object.values(grouped).forEach(g => {
        const tr = document.createElement("tr");
        
        // Tombol Remedial (Disable jika count == 0)
        const remedDisabled = g.remedialCount === 0;
        const btnRemedial = `
            <button class="btn-action btn-remed" ${remedDisabled ? "disabled" : ""} 
                onclick="startQuiz('${g.bab}', 'remedial')">
                Remedial (${g.remedialCount})
            </button>`;

        tr.innerHTML = `
            <td><span class="bab-badge">${g.bab}</span></td>
            <td style="font-weight:500">${g.nama}</td>
            <td><span class="score-badge">${g.score}</span></td>
            <td>
                <div class="btn-group">
                    <button class="btn-action btn-start" onclick="startQuiz('${g.bab}', 'full')">
                        Mulai Ujian
                    </button>
                    ${btnRemedial}
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// --- QUIZ LOGIC ---
function startQuiz(bab, mode) {
    currentBab = bab;
    isReviewMode = false;
    userAnswers = {};
    seconds = 0;
    
    // Filter Data
    let questions = allData.filter(x => x.bab == bab);
    if (mode === "remedial") {
        questions = questions.filter(x => x.note === "ULANG");
    }
    
    // Sort by Number
    questions.sort((a,b) => a.nomor - b.nomor);
    activeQuestions = questions;
    currentIndex = 0;

    // UI Updates
    document.getElementById("dashboard-view").classList.add("hidden");
    document.getElementById("quiz-view").classList.remove("hidden");
    document.getElementById("result-overlay").classList.add("hidden");
    document.getElementById("btn-finish").style.display = "block";
    document.getElementById("btn-back-menu").style.display = "none";
    document.getElementById("review-header").classList.add("hidden");
    
    // Judul
    const babName = questions[0]?.namaBab || "";
    document.getElementById("judul-quiz").innerText = `Bab ${bab} - ${mode === 'remedial' ? 'Remedial' : 'Full'} (${activeQuestions.length} Soal)`;

    startTimer();
    renderQuestion();
}

function renderQuestion() {
    const q = activeQuestions[currentIndex];
    const soalText = document.getElementById("soal-text");
    const opsiList = document.getElementById("opsi-list");
    const progressBar = document.getElementById("progress-bar");
    const posText = document.getElementById("judul-quiz"); // Update with position info if needed

    // Progress Bar
    const pct = ((currentIndex + 1) / activeQuestions.length) * 100;
    progressBar.style.width = pct + "%";

    // Content
    soalText.innerHTML = `<strong>No. ${q.nomor}</strong><br>${q.soal}`;
    
    // Toggle Button (Hanya tampil di mode review)
    if (isReviewMode) {
        document.getElementById("review-header").classList.remove("hidden");
        const toggle = document.getElementById("toggle-remedial");
        // Check apakah note == ULANG
        // Kita cek dari allData original untuk status terbaru, atau dari objek q
        toggle.checked = (q.note === "ULANG");
        // Simpan referensi soal aktif di toggle utk event handler
        toggle.dataset.bab = q.bab;
        toggle.dataset.nomor = q.nomor;
    }

    // Opsi
    let html = "";
    Object.keys(q.opsi).forEach(k => {
        let cls = "opsi";
        if (userAnswers[q.nomor] === k) cls += " active";
        
        if (isReviewMode) {
            if (k === q.jawaban) cls += " benar";
            else if (userAnswers[q.nomor] === k) cls += " salah";
        }

        html += `<div class="${cls}" onclick="answer('${k}')">
                    <span style="width:25px; font-weight:bold;">${k}.</span>
                    <span>${q.opsi[k]}</span>
                 </div>`;
    });
    opsiList.innerHTML = html;

    // Buttons
    document.getElementById("btn-prev").disabled = (currentIndex === 0);
    document.getElementById("btn-next").disabled = (currentIndex === activeQuestions.length - 1);
}

function answer(key) {
    if (isReviewMode) return; // Tidak bisa ganti jawaban saat review
    const q = activeQuestions[currentIndex];
    userAnswers[q.nomor] = key;
    renderQuestion(); // Re-render untuk efek highlight
}

function nav(dir) {
    currentIndex += dir;
    renderQuestion();
}

// --- TIMER ---
function startTimer() {
    clearInterval(timerInterval);
    const timerEl = document.getElementById("timer");
    timerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2,'0');
        const s = (seconds % 60).toString().padStart(2,'0');
        timerEl.innerText = `${m}:${s}`;
    }, 1000);
}

// --- SUBMIT & SAVE SCORE ---
function finishExam() {
    const answeredCount = Object.keys(userAnswers).length;
    if (answeredCount < activeQuestions.length) {
        if (!confirm("Masih ada soal kosong. Yakin selesai?")) return;
    }

    clearInterval(timerInterval);
    
    // Hitung Nilai
    let benar = 0;
    activeQuestions.forEach(q => {
        if (userAnswers[q.nomor] === q.jawaban) benar++;
    });
    const score = Math.round((benar / activeQuestions.length) * 100);

    // Tampilkan Result Overlay
    document.getElementById("quiz-view").classList.add("hidden");
    document.getElementById("result-overlay").classList.remove("hidden");
    document.getElementById("result-score").innerText = score;
    document.getElementById("result-msg").innerText = `Benar ${benar} dari ${activeQuestions.length} soal.`;

    // KIRIM SCORE KE GOOGLE SHEET
    // Hanya simpan score jika ini Full Exam (bukan remedial), opsional tergantung kebutuhan
    // Di sini saya set save setiap kali finish
    saveScoreToSheet(currentBab, score);
}

function saveScoreToSheet(bab, score) {
    fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            action: "saveScore",
            bab: bab,
            score: score
        })
    }).then(() => console.log("Score saved"));
}

// --- REVIEW & REMEDIAL MARKING ---
function reviewMode() {
    document.getElementById("result-overlay").classList.add("hidden");
    document.getElementById("quiz-view").classList.remove("hidden");
    
    isReviewMode = true;
    currentIndex = 0;
    
    // Ubah UI
    document.getElementById("btn-finish").style.display = "none";
    document.getElementById("btn-back-menu").style.display = "block";
    document.getElementById("btn-back-menu").classList.remove("hidden");
    
    renderQuestion();
}

function toggleMarking(el) {
    const bab = el.dataset.bab;
    const nomor = el.dataset.nomor;
    const action = el.checked ? "tandai" : "hapus";

    // Update Data Lokal (agar realtime di UI tanpa refresh)
    const q = allData.find(x => x.bab == bab && x.nomor == nomor);
    if(q) q.note = el.checked ? "ULANG" : "";

    // Kirim ke Backend
    fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            action: action,
            bab: bab,
            nomor: nomor
        })
    }).catch(err => console.error("Gagal update status", err));
}

function backToMenu() {
    window.location.reload();
}
</script>

</body>
</html>
